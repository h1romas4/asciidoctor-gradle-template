== ダイアグラム記法

本変換スクリプトでは `asciidoctorj-diagram` が有効になっており、いくつかのダイアグラム記法を追加のアドイン無しで使うことができます。

ダイアグラムを SVG ベクター画像で出力する指定は次のようになります。

[source]
-----
[ダイアグラム名, 出力ファイル名, svg, pdfwidth=70%, width=480px]
-----

``pdfwidth`` は PDF 紙面に対しての比率指定、``width`` は HTML 上の幅比率もしくはピクセル（``px``）で指定します。

本章では PlantUML と ditaa ダイアグラム記法を用いて、技術文書で使われやすい表現のいくつかの記述法を示します。詳しくはそれぞれのドキュメントを参考にしてください。

[quote, PlantUML]
____
https://plantuml.com/ja/

PlantUML in a nutshell
____

TIP: 変換スクリプトは PlantUML ダイアグラムの PDF 出力時に日本語が化けないよう、自動的にフォントパッチが適用されるよう構成されています。

[quote, ditaa]
____
https://ditaa.sourceforge.net/

DIagrams Through Ascii Art by Stathis Sideris
____

<<<<

=== シーケンス図

シーケンス図を PlantUML ダイアグラム記法で記述します。

[source]
-----
[plantuml, diag-sequence-sample2, svg, pdfwidth=70%, width=70%]
[caption=""]
----
include::puml/diag-sequence-sample2.puml[]
----
-----

[plantuml, diag-sequence-sample2, svg, pdfwidth=70%, width=70%]
[caption=""]
----
include::puml/diag-sequence-sample2.puml[]
----

.PlantUML ダイアグラムのリアルタイムプレビュー編集
****
本手順の VS Code の推奨プラグインとなっている PlantUML 拡張（``jebbs.plantuml``）を使うと、PlantUML のダイアグラム記法も VS Code 上でリアルタイムプレビューすることができます。

プレビュー処理をするために必要な PlantUML サーバは Docker コンテナで起動すると便利でしょう。なお、Gradle による文書の変換では内蔵の PlantUML ライブラリが使われますので本サーバーが起動している必要はありません。

[source, bash]
----
docker run -d --rm -p 8080:8080 plantuml/plantuml-server:jetty
----

`.vscode/setting.json` は次のようにポート ``8080`` で PlantUML サーバが起動されることを期待して構成してあります。

[source, json]
[caption=""]
.`.vscode/setting.json`
----
{ "plantuml.server": "http://localhost:8080" }
----

文書で使う PlantUML ダイアグラムを `.puml` 拡張子で保存することで Asciidoc と同様にプレビューアイコンが表示され、プレビュー画面ではリアルタイムに `.puml` ファイルの修正が反映されます。
****

<<<<

=== フォルダ・ファイルツリー

フォルダ・ファイルツリーを PlantUML の Salt 記法で記述します。

[source]
-----
[plantuml, diag-salt-sample1, svg, pdfwidth=30%, width=280px]
[caption=""]
----
include::puml/diag-salt-sample1.puml[]
----
-----

[plantuml, diag-salt-sample1, svg, pdfwidth=30%, width=280px]
[caption=""]
----
include::puml/diag-salt-sample1.puml[]
----

<<<<

=== 数式

数式を PlantUML の AsciiMath 記法で記述します。

[source]
-----
[plantuml, math-sample1, svg, pdfwidth=70%, width=70%]
[caption=""]
----
include::puml/math-sample1.puml[]
----
-----

[plantuml, math-sample1, svg, pdfwidth=70%, width=70%]
[caption=""]
----
include::puml/math-sample1.puml[]
----

- - -

.PlantUML の Salt 記法のフォントサイズ
****
Salt は現在のところ残念ながらフォントサイズの指定をすることができません。このため任意のフォントサイズにするためには出力画像の ``pdfwidth`` と ``width`` を設定して算出する必要があります。

[source]
----
@startsalt
<style>
saltDiagram {
  FontSize 10 // <1>
}
</style>
{
{T
 + <&folder> wp-admin
}
}
@endsalt
----

<1> 未実装で効果がない
****

<<<<

=== ブロック図

ブロック図を ditaa 記法で記述します。

TIP: ditta 内で日本語を使う場合は、表示ずれを防ぐため半角スペースなどで文字数を調整する必要があります。また、ドロップシャドー ``shadows`` 設定は HTML 版に対してのみ有効で、現在のところ PDF 版に対しては効果がないようです。

[source]
-----
[ditaa, diag-ditaa-block, svg, shadows=true, separation=true, pdfwidth=70%, width=70%]
[caption=""]
----
+---------------------------------+
|     baserCMS Plugin, Theme      |
+----------------------------+    +
| cPNK   baserCMS Core       |    |
+----------------------------+----+
|            CakePHP              |
+---------------------------------+
|             MySQL               |
+---------------------------------+

/-------------+-------------\
|cRED RED     |cBLU BLU     |
+-------------+-------------+
|cGRE GRE     |cPNK PNK     |
+-------------+-------------+
|cBLK BLK     |cYEL YEL     |
\-------------+-------------/
----
-----

[ditaa, diag-ditaa-block, svg, shadows=true, separation=true, pdfwidth=70%, width=70%]
[caption=""]
----
+---------------------------------+
|     baserCMS Plugin, Theme      |
+----------------------------+    +
| cPNK   baserCMS Core       |    |
+----------------------------+----+
|            CakePHP              |
+---------------------------------+
|             MySQL               |
+---------------------------------+

/-------------+-------------\
|cRED RED     |cBLU BLU     |
+-------------+-------------+
|cGRE GRE     |cPNK PNK     |
+-------------+-------------+
|cBLK BLK     |cYEL YEL     |
\-------------+-------------/
----

<<<<

=== ネットワーク構成図

ネットワーク構成図を PlantUML の nwdiag で記述します。

[source]
[caption=""]
.``diag-nwdiag-network1.puml``（分かりやすいように実際のソースより簡略化）
-----
[plantuml, diag-nwdiag-network1, svg]
----
@startuml diag-network1
<style>
nwdiagDiagram {
    FontSize 14
    group {
        BackGroundColor cadetblue
    }
}
</style>

nwdiag {
    internet [shape = cloud];
    internet -- router;
    router [address = "210.x.x.x"];
    network LAN {
        address = "192.168.0.0/24"
        router [address = "192.168.0.1"];
        thinkpad-p14s [address = "192.168.0.w"];
        minis-um690 [address = "192.168.0.x"];
        xbox-series-s [address = "192.168.0.y"];
        atom-server [address = "192.168.0.z", shape = database"]
    }
    network WLAN {
        address = "172.16.15.0/24"
        router [address = "172.16.15.1"];
        group {
            description = モバイル
            iphone01 [address = "172.16.15.w"];
            ipad01 [address = "172.16.15.x"];
        }
        group {
            color = "#add8e6"
            description = 据え置き
            fire01 [address = "172.16.15.y"];
            echo01 [address = "172.16.15.z"];
        }
    }
}
@enduml
----
-----

[plantuml, diag-nwdiag-network1, svg]
[caption=""]
----
include::puml/diag-nwdiag-network1.puml[]
----

<<<<

=== タイミングチャート

デジタル回路などのタイミングチャートを PlantUML で記述します。

[source]
[caption=""]
.``diag-timing-sample1.puml``（実際のソースより抜粋）
-----
[plantuml, diag-timing-sample1, svg, pdfwidth=100%, width=100%]
----
@startuml diag-timing-sample1
scale 40 as 150 pixels
clock "Clock" as clk with period 1
binary "CS" as CS
binary "WR" as WR
binary "RD" as RD
binary "A0" as A0
binary "A1" as A1
binary "IC" as IC
concise "DataBus" as DB

@0 as :start
@20 as :set_data_bus_1
@30 as :set_addr_1
@40 as :write_start_1
@60 as :write_end_1

@:start
IC is high
CS is high
WR is high
RD is low
A0 is low
A1 is low

@:set_data_bus_1
DB is "0xff"
DB -> WR@+20

@:set_addr_1
A0 is high
A1 is low

@:write_start_1
CS is low : WR/CS と同時に設定
WR is low

@:write_end_1
CS is high
WR is high

highlight 40 to 60 #Gold;line:DimGrey : 書き込み
@enduml
----
-----

[plantuml, diag-timing-sample1, svg, pdfwidth=100%, width=100%]
[caption=""]
----
include::puml/diag-timing-sample1.puml[]
----
