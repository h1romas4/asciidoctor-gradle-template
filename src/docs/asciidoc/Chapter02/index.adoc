include::../attribute.adoc[]

== Asciidoc から HTML/PDF 文書を作成する

=== サンプル文書の変換を試す

環境の準備ができましたので Asciidoc 文書を HTML/PDF に変換してみます。

変換に使うスクリプトは GitHub のリポジトリに公開されており、リポジトリには HTML/PDF 変換に使うファイル一式と、文書サンプルとして "この文書" の Asciidoc ファイルが置かれています。まずはサンプル文書が正しく変換できるかを試してみましょう。

macOS / Linux の場合は次のようにします。

[source]
[caption="手順. "]
.PDF 変換ビルドスクリプトの取得と実行
----
$ curl -L -O https://github.com/h1romas4/asciidoctor-gradle-template/archive/master.zip # <1>
$ unzip master.zip # <2>
$ cd asciidoctor-gradle-template-master # <3>
$ ./gradlew docs # <4>
BUILD SUCCESSFUL in 19s <5>
2 actionable tasks: 2 executed
----

<1> リポジトリのファイルをダウンロードします。
<2> ダウンロードした .zip ファイルを展開します。
<3> カレントディレクトリを展開したフォルダの中に移します。フォルダ名は任意のものに変更可能です。本手順ではプロジェクトフォルダと呼称します。
<4> Gradle のビルドを実行します。初回実行時はビルドに必要なファイルをダウンロードするため少し時間がかかります。次回以降は30秒程度で完了します。
<5> ``BUILD SUCCESSFUL`` が出力されればビルド成功です。

<<<

Windows をお使いの場合は同等の操作をブラウザとエクスプローラーを使って行います。

[IMPORTANT]
====
Windows の場合 .zip ファイルの展開先はマルチバイト文字を含まないパスにしてください。JRuby の制約により変換処理がエラーとなります。また、プロジェクト内部で使うフォルダやファイル名のマルチバイト名も同様です。
====

. ブラウザを使って ``https://github.com/h1romas4/asciidoctor-gradle-template/archive/master.zip`` にアクセスしリポジトリのファイルを取得します。
. ダウンロードした .zip ファイルを右クリックし展開します。フォルダ名は任意のものに変更可能です。本手順ではプロジェクトフォルダと呼称します。
. 展開したフォルダ内をエクスプローラーで表示した上で、アドレスバーに ``cmd.exe`` と入力し、このフォルダをカレントディレクトリとしてコマンドプロンプトを起動します。
+
image::windows-01.png[windows, pdfwidth=70%, width=70%]

. ``.\gradlew.bat docs`` と入力し Gradle ビルドを実行します。初回実行時はビルドに必要なファイルをダウンロードするため少し時間がかかります。次回以降は30秒程度で完了します。
. ``BUILD SUCCESSFUL`` が出力されればビルド成功です。

.プロキシーサーバーの設定
****
もしお使いのコンピューターがプロキシーサーバー経由のインターネットアクセスを行う場合は、次のコマンドを ``./gradlew docs`` をする前に入力してください。インターネットを使ったライブラリの取得が正しく行われるようになります。ホスト名（``example.com``） と ポート番号（``8080``）部分はそれぞれの環境に合わせてください。

[source]
[caption="手順. "]
.プロキシーサーバー設定（Windows）
----
set JAVA_OPTS=-DproxyHost=example.com -DproxyPort=8080
----

[source]
[caption="手順. "]
.プロキシーサーバー設定（macOS / Linux）
----
export JAVA_OPTS=-DproxyHost=example.com -DproxyPort=8080
----
****

<<<

=== 変換後の文書

``./gradlew docs`` のビルド操作により Asciidoc から変換された文書は、``docs`` フォルダに HTML版(``index.html``)と PDF版（``index.pdf``）として格納されます。

[caption="画像."]
.HTML 文書
image::html.png[html, pdfwidth=80%, width=80%]

[caption="画像."]
.PDF 文書
image::pdf.png[pdf, pdfwidth=80%, width=80%]

<<<<

成果物の出力先となる ``docs`` フォルダの構成は次のとおりです。

[plantuml, directory-structure-1, svg, pdfwidth=72%, width=690px]
[caption=""]
----
include::puml/directory-structure-1.puml[]
----

成果物文書のソースとなるのは ``src/docs/asciidoc`` に配置された Asciidoc 文書と画像ファイル群です。

[plantuml, directory-structure-2, svg, pdfwidth=55%, width=522px]
[caption=""]
----
include::puml/directory-structure-2.puml[]
----

``docs`` 出力フォルダの構成としては、章（``Chapter*/images``）フォルダには HTML 版からリンクされるリソースが ``src/docs/asciidoc`` からコピーされ配置されます。また、後述するダイアグラム記法を使った図表や数式も、ビルドのタイミングでベクター画像が生成され同フォルダに出力されます。

PDF 版のファイルについては ``index.pdf`` 単体で完結しており、フォントや画像リソースなど全てが PDF ファイル内に格納されます。

以上から成果物の配布は次のようになります。

[format="csv",cols="1,2"]
[frame="topbot",grid="none"]
|======
HTML 文書,``docs``フォルダの ``index.pdf``を除く全てのファイルを配布。
PDF 文書, ``docs/index.pdf`` のみを配布。
|======

なおいずれの場合も ``index.*`` のファイル名は任意の名称に変更可能です。

[IMPORTANT]
====
``docs`` フォルダは成果物の出力専用フォルダとなっており、ビルド時にいったん全てのファイルが削除されますので、**自らが作成したファイルは配置しない**ように注意してください。執筆で作成するファイルは必ず ``src/docs/asciidoc`` 配下に配置します。
====

=== テキストエディタで Asciidoc 文書を編集する

==== VS Code によるリアルタイムプレビュー

プロジェクトフォルダに配置された Asciidoc 文書は、Visual Studio Code を利用してリアルタイムに変換結果をプレビューしながら編集できるように準備されています。

プロジェクトフォルダを Visual Studio Code で開き、拡張機能の推奨事項から拡張を導入します。

NOTE: 拡張機能の推奨は ``.vscode/extention.json`` で設定されています。文書に応じて設定し、執筆メンバーの環境を揃えることができます。

. btn:[すべてインストール] ボタンをクリックします。
+
image::vscode-extention1.png[vscode, pdfwidth=50%]

. btn:[再読み込み] ボタンをクリックします。
+
image::vscode-extention2.png[vscode, pdfwidth=50%]
+
<<<
. Asciidoc 文書（``src/docs/asciidoc/index.adoc``など）を Visual Studio Code のエクスプローラーから選択して開き、文書を開いたエディタ部右上に配置された btn:[Open Preview to the Side]アイコンをクリックすると、画面右側に Asciidoc 文書の変換がリアルタイムに確認できるプレビューが表示されます。
+
image::vscode-asciidoc.png[vscode, 600]

==== クリップボードからの画像挿入

本手順で VS Code の推奨拡張として導入される https://marketplace.visualstudio.com/items?itemName=mushan.vscode-paste-image[Paste Image]（``mushan.vscode-paste-image``） は、クリップボード上にある画像をファイルとして指定の位置に格納した上で、Asciidoc 文書にリンクを挿入する便利な拡張です。

特にコンピュータの操作手順文書をつくる場合に活用すると強力です。次のような簡単な操作でクリップボードの画像を Asciidoc 文書に挿入できます。

. スクリーンキャプチャなどの機能でクリップボードに画像を保持する。
. VS Code で Asciidoc 文書を開き、menu:VS Code[F1 キー押下 > Paste Image と入力 > エンターキーで選択]する。
+
image::2023-06-30-12-11-56.png[pdfwidth=70%]

Asciidoc 文書には画像リンクが挿入されるとともに、開いている Asciidoc 文書から相対で ``images/`` として見えるパスに画像ファイルが格納され、文書への画像挿入がひとつの操作で完了します。

[source]
[caption=""]
----
image::2023-06-30-12-11-56.png[]
----

画像ファイル名の命名規約や出力先のフォルダ設定は ``.vscode/setting.json`` で行うことができます。

[source, json]
[caption=""]
.``.vscode/setting.json``
----
{
    "pasteImage.path": "${currentFileDir}/images",
    "pasteImage.basePath": "${currentFileDir}/images",
    "pasteImage.defaultName": "Y-MM-DD-HH-mm-ss",
}
----

Asciidoc 拡張にも同様の機能（menu:VS Code[F1 キー押下 > AsciiDoc: Paste Image]）がありますが、現在のところ Paste Image 拡張のほうがファイル名などの設定が柔軟であるため本手順では Paste Image を紹介しています。

AsciiDoc: Paste Image は現在の開いている Asciidoc の ``:imagesdir:`` 属性を見て設定無しでファイル配置場所を決定してくれるなど優れた機能もありますので、それぞれの機能を確認し必要に応じて使い分けると良いでしょう。

.クリップボード連携のシステムインターフェース
****
Paste Image 拡張のクリップボード連携のシステムインターフェースは次のシェルスクリプトで実装されています。Asciidoc 拡張も ``~/.vscode/extensions/asciidoctor.asciidoctor-vscode-2.9.8/res`` 配下に同様のファイルがあります。

クリップボード連携は VS Code のセキュリティーポリシー外の世界で動作しますので、動作をご理解の上設定してください。

[source, bash]
----
$ ls -laF ~/.vscode/extensions/mushan.vscode-paste-image-1.0.4/res
..snip..
-rw-r--r-- 1 hiromasa hiromasa   492  6月 26  2021 linux.sh
-rw-r--r-- 1 hiromasa hiromasa  1540  6月 26  2021 mac.applescript
-rw-r--r-- 1 hiromasa hiromasa   680  6月 26  2021 pc.ps1
..snip..
----
****

<<<<

=== 文書のファイル構成

以下に文書のフォルダとファイル構成を示します。VS Code でプレビュー確認を行いながら、サンプル文書から執筆したい文書に合わせカスタマイズしていきます。

[plantuml, directory-structure-3, svg, pdfwidth=40%, width=390px]
[caption=""]
----
include::puml/directory-structure-3.puml[]
----

[source]
[caption=""]
----
src/docs/asciidoc/index.adoc # <1>
src/docs/asciidoc/attribute.adoc # <2>
src/docs/asciidoc/@style/asciidoctor.css # <3>
src/docs/asciidoc/@style/pdf-theme.yml # <4>
src/docs/asciidoc/@font/**/*.ttf # <5>
src/docs/asciidoc/Chapter{number}/index.adoc <6>
build.gradle <7>
----

<1> 文書を作成する起点となる Asciidoc 文書です。表紙となる文書のタイトルなどを記載し、その後から章ごとの Asciidoc 文書を ``include`` して構成していきます。
<2> 文書設定をするためのファイルです。各文書から ``include`` します。
<3> HTML 出力とプレビュー用のスタイルシートです。文書に合わせて修正することができます。
<4> PDF 文書に変換する際に使われるスタイル定義です。文書に合わせて修正することができます。
<5> PDF 文書に埋め込みされるフォントファイルを配置します。``pdf-theme.yml`` からファイル名で参照されています。TrueType フォント ``.ttf`` が指定できます。
<6> ``src/docs/asciidoc/index.adoc`` から参照される子文書です。``build.gradle`` による画像パス解決のためフォルダ名は ``Chapter{number}`` とします。
<7> 文書を変換する Gradle ビルドスクリプトです。Asciidoc 文書や画像パスの設定があります。

==== 文書属性定義

``src/docs/asciidoc/attribute.adoc`` では文書のデフォルトキャプション名などの属性定義が行えます。必要に応じて修正してください。

[source, javascript]
[caption=""]
.``src/docs/asciidoc/attribute.adoc``
----
..snip..
:preface-title: まえがき
:toc-title: 目次
:appendix-caption: 付録
:caution-caption: 注意
:example-caption: 例
:figure-caption: 図
..snip..
----

Asciidoctor で利用可能な属性は次から参照できます。

[quote, asciidoctor.org]
____
https://asciidoctor.org/docs/user-manual/#attributes

Attributes are one of the features that sets Asciidoctor apart from other lightweight markup languages. Attributes can activate features (behaviors, styles, integrations, etc) or hold replacement (i.e., variable) content.
____

==== PDF テーマ定義

``src/docs/asciidoc/@style/pdf-theme.yml`` では PDF 文書のスタイルを定義することができます。

属性の詳細は次から参照できます。

[quote, asciidoctor.org]
____
https://docs.asciidoctor.org/pdf-converter/latest/

Asciidoctor PDF Theming Guide
____

``pdf-theme.yml`` の修正は ``.adoc`` 修正時のビルドで PDF 文書に反映します。``pdf-theme.yml`` の修正だけを反映したい場合は、いずれかの ``.adoc`` 文書に影響のない修正を加えてファイルを更新するか、 ``./gradlew clean`` してからビルドを実行してください。

IMPORTANT: 本手順で採用している Asciidoctor PDF のバージョンは ``1.6.2`` です。日本語禁則処理を正しく動作させるために、現在のところ最新の ``2.3`` にはなっていません。新しい Theming Guide ドキュメントの属性や動作とは乖離している場合があることに注意してください。

=== 執筆の開始

一通りのサンプル文書の構成確認が終りましたら、次のような流れでご自身の執筆を開始してみてください。

. サンプル文書の ``src/docs/asciidoc/Cahpter02`` 以降のフォルダの削除を行い見通しを良くする。
. ``src/docs/asciidoc/index.adoc`` からの 1. で削除した ``Chapter*`` の``include`` を削除する。
. ``src/docs/asciidoc/index.adoc`` で文書のタイトルや版数などを設定する。
. ``src/docs/asciidoc/Cahpter00/index.adoc`` を空にして目次前に挿入される「はじめに」や「本書の読み方」等の執筆。
. ``src/docs/asciidoc/Cahpter01/index.adoc`` を空にして本編の執筆を開始。
. 事前に目次案がある場合は、このタイミングで ``Chapter*`` フォルダと対応する ``index.adoc`` を新規作成し、目次案にあった章や節などの大項目のみを準備するのも良い方法です。目次が完成し全体の把握がしやすくなります。
. ここで一度 ``./gradlew docs`` を行い、想定通りの HTML/PDF 文書が ``docs/`` 内に生成されていることを確認する。外観の修正点があれば、
** 文書形式の場合は ``src/docs/asciidoc/attribute.adoc`` を調整。
** PDF テーマの場合は ``src/docs/asciidoc/@style/pdf-theme.yml`` を調整。
** HTML テーマの場合は ``src/docs/asciidoc/@style/asciidoctor.css`` を調整。

=== 執筆のイテレーション

ここまでの手順で執筆環境が整った後の、文書執筆の進め方のイメージは次のようになります。

. プロジェクトフォルダを VS Code で開く。
. ``src/docs/asciidocs`` 配下の Asciidoc 文書を VS Code でプレビューしながら執筆する。
+
* Chapter が増えた場合は ``src/docs/asciidocs/index.adoc`` に Chapter を追記し、``src/docs/asciidocs/Chapter*/index.adoc`` ファイルを新規追加する。
* 画像ファイルが必要な場合は、``src/docs/asciidocs/Chapter*/images`` フォルダに追加する。
. 文書執筆の一定の区切りをもって ``./gradlew docs`` で文書のビルドを行い、HTML/PDF 文書を ``docs/index.html`` と ``docs/index.pdf`` で推敲する。
+
* ``./gradlew docs`` の入力は VS Code の統合ターミナルが使えます。
. 必要ならばプロジェクトディレクトリを Git などのバージョン管理下として、コミットを行う。
. 本日の執筆を終え、明日はまた 1. に戻る。

TIP: 推敲は、生成された PDF 文書を iPad などペンシルデバイスを持つ機械に転送し「赤入れ」すると便利かもしれません。

=== クラウドによる執筆

クラウド統合環境である https://www.gitpod.io/[Gitpod] を活用すると、ローカル環境の準備なしにウェブブラウザ上での執筆と HTML/PDF 文書の変換が可能です。サブマシンや iPad などタブレット端末でも執筆が行えます。

[quote, Gitpod]
____
https://www.gitpod.io/

The developer platform for on-demand cloud development environments. Create software faster and more securely.
____

実行にあたっての条件は次のとおりです。

- 文書ファイル一式を GitHub、GitLab、Bitbucket のいずれかに配置する必要があります。（プライベートリポジトリも利用可能です）
- 2023-07 現在 Gitpod の無料枠は 50時間/月です。それ以上は利用料が必要です。

準備ができれば、次の要領で URL を作成しウェブブラウザでアクセスすると環境が起動します。まずは本手順のリポジトリで試してみるのも良いでしょう。

NOTE: Gitpod 向けの設定は ``.gitpod.yml`` ファイルで定義されています。

[source]
----
https://gitpod.io/new/#https://github.com/h1romas4/asciidoctor-gradle-template <1>
----

<1> ``https://github.com/h1romas4/asciidoctor-gradle-template`` 部分を自身の GitHub リポジトリにしてウェブブラウザの URL 欄に貼り付けます。本手順の試用の場合はこのままでかまいません。

[caption="画像."]
.ウェブブラウザ上で起動した VS Code と Asciidoc 拡張
image::2023-07-03-14-28-22.png[pdfwidth=76%]

起動後に VS Code 推奨拡張導入のダイアログが出力されますので、確認してインストールしてください。

.VS Code の Zen Mode
****
VS Code には執筆に集中したい場合に、不要な UI を隠しながらフルスクリーン表示をする Zen Mode があります。標準のキーアサインでは btn:[Ctrl + k, z] でモードが遷移し、再度同じ操作で元の画面に戻ります。

image::2023-07-02-15-09-43.png[pdfwidth=84%, width=90%]

Zen Mode は、VS Code や OS の不要なコンポーネントが見えなくなり画面が広く使えること、また思考を遮る要素がなくなることから快適な執筆のユーティリティとなります。
****
